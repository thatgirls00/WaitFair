name: WaitFair Backend CI

on:
  pull_request:
    paths:
      - "backend/**"

  push:
    branches: [ main ]

permissions:
  contents: read
  checks: write
  pull-requests: write

jobs:
  backend-test:
    runs-on: ubuntu-latest

    defaults:
      run:
        working-directory: backend

    env:
      SPRING_PROFILES_ACTIVE: test
      SPRING_DATASOURCE_URL: jdbc:h2:mem:testdb;MODE=MySQL;DB_CLOSE_DELAY=-1;
      SPRING_DATASOURCE_USERNAME: sa
      SPRING_DATASOURCE_PASSWORD: ""

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Ensure base commit is fetched (PR only)
        if: github.event_name == 'pull_request'
        run: |
          BASE_SHA='${{ github.event.pull_request.base.sha }}'
          if ! git cat-file -e "$BASE_SHA^{commit}" 2>/dev/null; then
            git fetch --no-tags --prune origin "$BASE_SHA":"refs/remotes/origin/base-sha"
          fi

      - name: Set up Java 21
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 21

      - name: Cache Gradle packages
        uses: actions/cache@v3
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
          restore-keys: ${{ runner.os }}-gradle-

      - name: Grant execute permission for Gradle Wrapper
        run: chmod +x gradlew

      - name: Build without tests
        run: ./gradlew build -x test -x checkstyleMain -x checkstyleTest --no-daemon

      - name: Run Checkstyle
        run: ./gradlew checkstyleMain checkstyleTest --no-daemon
        continue-on-error: false

      - name: Write application-test.yml from secret
        working-directory: backend
        run: |
          mkdir -p src/test/resources
          cat > src/test/resources/application-test.yml <<'YAML'
          ${{ secrets.APPLICATION_TEST_YML }}
          YAML

      - name: Show test resources
        working-directory: backend
        run: ls -al src/test/resources || true

      # Ï†ÑÏ≤¥(Îã®ÏúÑ+ÌÜµÌï©) Ïã§Ìñâ
      - name: Run Full Test
        run: ./gradlew --no-daemon clean fullTest --info --stacktrace -x checkstyleMain -x checkstyleTest

      - name: Generate JaCoCo (fullTest)
        if: always()
        run: ./gradlew clean jacocoFullTestReport --rerun-tasks --no-daemon

      # Ïã§Ìå®/ÏÑ±Í≥µÍ≥º Î¨¥Í¥ÄÌïòÍ≤å Î¶¨Ìè¨ÌåÖ Îã®Í≥ÑÎäî ÏßÑÌñâ
      - name: Publish Unit Test Results (JUnit)
        if: always()
        uses: EnricoMi/publish-unit-test-result-action@v2
        with:
          files: |
            backend/build/test-results/test/*.xml
            backend/build/test-results/fullTest/*.xml
          check_run: true
          comment_mode: always

      - name: Upload failed-tests.txt (if exists)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: failed-tests
          path: backend/build/reports/tests/failed-tests.txt
          if-no-files-found: ignore

      - name: Upsert PR comment with failed tests
        if: always()
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const path = 'backend/build/reports/tests/failed-tests.txt';
            const MARK = '<!-- FAILED-TESTS-SUMMARY -->';

            function buildBody(textBlock) {
              return [
                MARK,
                '### ‚ùå Failed Tests (from Gradle summary)',
                '',
                '<details><summary>Expand</summary>',
                '',
                '```text',
                textBlock,
                '```',
                '',
                '</details>'
              ].join('\n');
            }

            if (!context.payload.pull_request) {
              core.info('Not a PR event, skip commenting');
              return;
            }

            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.payload.pull_request.number,
              per_page: 100
            });

            // ÌååÏùºÏù¥ ÏóÜÍ±∞ÎÇò, No failuresÎ©¥ Í∏∞Ï°¥ ÎßàÏª§ ÎåìÍ∏Ä ÏÇ≠Ï†ú
            if (!fs.existsSync(path)) {
              const existing = comments.find(c => c.user.type === 'Bot' && c.body.includes(MARK));
              if (existing) {
                await github.rest.issues.deleteComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  comment_id: existing.id
                });
              }
              return;
            }

            const content = fs.readFileSync(path, 'utf8').trim();
            if (!content || content === 'No failures üéâ') {
              const existing = comments.find(c => c.user.type === 'Bot' && c.body.includes(MARK));
              if (existing) {
                await github.rest.issues.deleteComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  comment_id: existing.id
                });
              }
              return;
            }

            const body = buildBody(content);
            const existing = comments.find(c => c.user.type === 'Bot' && c.body.includes(MARK));
            if (existing) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: existing.id,
                body
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.payload.pull_request.number,
                body
              });
            }

      - name: Upload Test Report HTML
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: jacoco-full-html
          path: backend/build/reports/jacocoFull/html
          if-no-files-found: warn

      - name: Install xmllint
        if: always()
        run: sudo apt-get update && sudo apt-get install -y libxml2-utils

      - name: Compute coverage & upsert PR comment
        if: always() && github.event_name == 'pull_request'
        id: cov
        run: |
          ls -al build/reports/jacocoFull/xml || true
          ls -al build/reports/jacoco/xml || true
          ls -al build/jacoco || true

          # ÌïòÎÇòÏùò Î¶¨Ìè¨Ìä∏Î°ú Ïòà: fullTest Í∏∞Ï§Ä
          XML="build/reports/jacocoFull/xml/jacocoFullTestReport.xml"
          if [ ! -f "$XML" ]; then
            echo "XML not found: $XML"
            ALT="build/reports/jacoco/xml/jacocoTestReport.xml"
            if [ -f "$ALT" ]; then
              XML="$ALT"
            else
              echo "pct=0" >> $GITHUB_OUTPUT
              exit 0
            fi
          fi

          COVERED=$(xmllint --xpath "string(sum(//counter[@type='LINE']/@covered))" "$XML")
          MISSED=$(xmllint --xpath "string(sum(//counter[@type='LINE']/@missed))" "$XML")
          TOTAL=$(( ${COVERED%.*} + ${MISSED%.*} ))
          PCT=0
          if [ "$TOTAL" -ne 0 ]; then
            # ÏÜåÏàòÏ†ê 2ÏûêÎ¶¨
            PCT=$(awk "BEGIN { printf \"%.2f\", ($COVERED/($COVERED+$MISSED))*100 }")
          fi
          echo "pct=$PCT" >> $GITHUB_OUTPUT
        shell: bash

      - name: Build detailed coverage markdown (incl. Changed Files)
        if: always() && github.event_name == 'pull_request'
        id: covmd
        run: |
          # Î¶¨Ìè¨Ìä∏ Í≤ΩÎ°ú Í≤∞Ï†ï
          XML="build/reports/jacocoFull/xml/jacocoFullTestReport.xml"
          if [ ! -f "$XML" ]; then
            ALT="build/reports/jacoco/xml/jacocoTestReport.xml"
            if [ -f "$ALT" ]; then
              XML="$ALT"
            else
              echo "details=No coverage report found." >> $GITHUB_OUTPUT
              exit 0
            fi
          fi
          echo "Using coverage XML: $XML"

          BASE_SHA='${{ github.event.pull_request.base.sha }}'
          HEAD_SHA='${{ github.sha }}'

          # Î≤†Ïù¥Ïä§ Ïª§Î∞ãÏù¥ ÏóÜÏúºÎ©¥ fetch (Ïù¥Ï§ë Î∞©Ïñ¥)
          if ! git cat-file -e "$BASE_SHA^{commit}" 2>/dev/null; then
            git fetch --no-tags --prune origin "$BASE_SHA":"refs/remotes/origin/base-sha" || true
          fi

          git diff --name-only "$BASE_SHA" "$HEAD_SHA" \
            | grep -E '^backend/src/main/(java|kotlin)/.*\.(java|kt)$' \
            | sed 's#^backend/##' > /tmp/changed-java.txt || true

          echo "Changed files (main src):"
          cat /tmp/changed-java.txt || true
          echo

          # ÌååÏù¥Ïç¨ÏóêÎäî ÌôòÍ≤ΩÎ≥ÄÏàòÎ°ú XML Í≤ΩÎ°úÎßå ÎÑòÍ∏∞Í≥†, heredocÏùÄ 'quoted'Î°ú Ïú†ÏßÄ
          export XML="$XML"

          python3 - <<'PY' > /tmp/coverage_details.md
          import os
          import xml.etree.ElementTree as ET
          from pathlib import Path

          xml_path = Path(os.environ["XML"])
          root = ET.parse(xml_path).getroot()

          def sum_counter(node, ctype):
              for c in node.findall("counter"):
                  if c.get("type") == ctype:
                      return int(c.get("covered", "0")), int(c.get("missed", "0"))
              return 0, 0

          tot_cov, tot_miss = sum_counter(root, "LINE")
          tot_pct = (tot_cov / (tot_cov + tot_miss) * 100) if (tot_cov + tot_miss) else 0.0

          # Ìå®ÌÇ§ÏßÄÎ≥Ñ
          pkg_rows = []
          for p in root.findall("package"):
              pcov, pmiss = sum_counter(p, "LINE")
              if pcov + pmiss == 0:
                  for c in p.findall("class"):
                      cc, cm = sum_counter(c, "LINE")
                      pcov += cc; pmiss += cm
              ppct = (pcov / (pcov + pmiss) * 100) if (pcov + pmiss) else 0.0
              pkg_rows.append((p.get("name","(default)"), pcov, pmiss, ppct))
          pkg_rows.sort(key=lambda r: r[3])

          # ÌÅ¥ÎûòÏä§Î≥Ñ
          class_rows = []
          for p in root.findall("package"):
              for c in p.findall("class"):
                  cc, cm = sum_counter(c, "LINE")
                  total = cc + cm
                  pct = (cc/total*100) if total else 0.0
                  cname = c.get("name","(unknown)").replace("/", ".")
                  class_rows.append((cname, cc, cm, pct, total))
          class_rows.sort(key=lambda r: (r[3], -r[4]))

          # Î≥ÄÍ≤Ω ÌååÏùº Îß§Ìïë
          changed_rows = []
          changed_file_list = Path("/tmp/changed-java.txt")
          if changed_file_list.exists():
              for line in changed_file_list.read_text().splitlines():
                  line = line.strip()
                  if not line: continue
                  if line.startswith("src/main/java/"):
                      rel = line[len("src/main/java/"):]
                  elif line.startswith("src/main/kotlin/"):
                      rel = line[len("src/main/kotlin/"):]
                  else:
                      continue
                  if rel.endswith(".java"): rel = rel[:-5]
                  elif rel.endswith(".kt"): rel = rel[:-3]
                  fqn = rel.replace("/", ".")

                  matches = [r for r in class_rows if r[0].startswith(fqn)]
                  if matches:
                      cov = sum(m[1] for m in matches)
                      miss = sum(m[2] for m in matches)
                      total = cov + miss
                      pct = (cov/total*100) if total else 0.0
                      changed_rows.append((line, fqn, cov, miss, pct, total))
                  else:
                      changed_rows.append((line, fqn, 0, 0, 0.0, 0))
              changed_rows.sort(key=lambda r: (r[4], -r[5]))

          def fmt_pct(x): return f"{x:.2f}%"

          print("### üìä Coverage Details\n")
          print(f"**Overall Line Coverage:** {fmt_pct(tot_pct)} ({tot_cov} covered / {tot_cov+tot_miss} lines)\n")

          if pkg_rows:
              print("<details><summary><b>Package Summary (lowest first)</b></summary>\n")
              print("| Package | Line % | Covered | Missed |")
              print("|---|---:|---:|---:|")
              for (name, cov, miss, pct) in pkg_rows:
                  print(f"| `{name}` | {fmt_pct(pct)} | {cov} | {miss} |")
              print("\n</details>\n")

          print("<details open><summary><b>Lowest Covered Classes (Top 20)</b></summary>\n")
          print("| Class | Line % | Covered | Missed |")
          print("|---|---:|---:|---:|")
          for (cname, cov, miss, pct, total) in class_rows[:20]:
              print(f"| `{cname}` | {fmt_pct(pct)} | {cov} | {miss} |")
          print("\n</details>\n")

          if changed_rows:
              print("<details open><summary><b>Changed Classes (from this PR)</b></summary>\n")
              print("| Source (PR) | Class Prefix | Line % | Covered | Missed |")
              print("|---|---|---:|---:|---:|")
              for (src, fqn, cov, miss, pct, total) in changed_rows:
                  print(f"| `{src}` | `{fqn}` | {fmt_pct(pct)} | {cov} | {miss} |")
              print("\n</details>\n")
          PY

          {
            echo 'details<<EOF'
            cat /tmp/coverage_details.md
            echo 'EOF'
          } >> $GITHUB_OUTPUT

      - name: Upsert PR comment (coverage)
        if: always() && github.event_name == 'pull_request'
        uses: actions/github-script@v7
        env:
          PCT: ${{ steps.cov.outputs.pct }}
          DETAILS: ${{ steps.covmd.outputs.details }}
        with:
          script: |
            const MARK = '<!-- JACOCO-COVERAGE-SUMMARY -->';
            const pct = process.env.PCT || '0';
            const details = process.env.DETAILS || '';
            const runUrl = `https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`;
            const body = `${MARK}
            ### üß™ WaitFair Test Coverage
            **Line Coverage:** ${pct}%

            ${details}

            üîó **Full HTML report**: See artifact **jacoco-full-html** on this run ‚Üí ${runUrl}
            `;

            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.payload.pull_request.number,
              per_page: 100
            });
            const existing = comments.find(c => c.user.type === 'Bot' && c.body.includes(MARK));
            if (existing) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: existing.id,
                body
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.payload.pull_request.number,
                body
              });
            }
      - name: Parse test results
        if: always()
        id: test_results
        working-directory: backend
        run: |
          # fullTest Í≤∞Í≥º ÌååÏùº Ï∞æÍ∏∞
          TEST_DIR="build/test-results/fullTest"

          if [ -d "$TEST_DIR" ] && [ -n "$(find "$TEST_DIR" -name 'TEST-*.xml' 2>/dev/null)" ]; then
            echo "Found test results in $TEST_DIR"

            # ÌÖåÏä§Ìä∏ ÌÜµÍ≥Ñ ÌååÏã±
            TOTAL=$(find "$TEST_DIR" -name "TEST-*.xml" -exec grep -h 'tests=' {} \; | sed 's/.*tests="\([0-9]*\)".*/\1/' | awk '{s+=$1} END {print s}')
            FAILURES=$(find "$TEST_DIR" -name "TEST-*.xml" -exec grep -h 'failures=' {} \; | sed 's/.*failures="\([0-9]*\)".*/\1/' | awk '{s+=$1} END {print s}')
            SKIPPED=$(find "$TEST_DIR" -name "TEST-*.xml" -exec grep -h 'skipped=' {} \; | sed 's/.*skipped="\([0-9]*\)".*/\1/' | awk '{s+=$1} END {print s}')

            # Îπà Í∞í Ï≤òÎ¶¨
            TOTAL=${TOTAL:-0}
            FAILURES=${FAILURES:-0}
            SKIPPED=${SKIPPED:-0}
            PASSED=$((TOTAL - FAILURES - SKIPPED))

            echo "Test Results: Total=$TOTAL, Passed=$PASSED, Failed=$FAILURES, Skipped=$SKIPPED"
            echo "total=$TOTAL" >> $GITHUB_OUTPUT
            echo "passed=$PASSED" >> $GITHUB_OUTPUT
            echo "failed=$FAILURES" >> $GITHUB_OUTPUT
            echo "skipped=$SKIPPED" >> $GITHUB_OUTPUT
          else
            echo "No test results found in $TEST_DIR"
            echo "total=0" >> $GITHUB_OUTPUT
            echo "passed=0" >> $GITHUB_OUTPUT
            echo "failed=0" >> $GITHUB_OUTPUT
            echo "skipped=0" >> $GITHUB_OUTPUT
          fi